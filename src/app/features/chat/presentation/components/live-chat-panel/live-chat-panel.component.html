<mat-card class="panel">
  <!-- Header -->
  <div class="header">
    <div class="title">
      <div class="h1">Chat en Vivo</div>

      <div class="subtitle-row">
        <div class="h2">Chat con {{ peerName }}</div>

        <!-- ✅ NUEVO: indicador cuando el usuario limpió la pantalla -->
        <mat-chip *ngIf="vm.viewCleared()" class="chip-clean" aria-label="Vista limpia">
          <mat-icon class="chip-ic" aria-hidden="true">delete_sweep</mat-icon>
          Vista limpia
        </mat-chip>
      </div>
    </div>

    <div class="actions">
      <button mat-icon-button matTooltip="Buscar" aria-label="Buscar">
        <mat-icon>search</mat-icon>
      </button>

      <button
        mat-icon-button
        [matMenuTriggerFor]="chatMenu"
        matTooltip="Opciones"
        aria-label="Opciones"
      >
        <mat-icon>more_vert</mat-icon>
      </button>

      <button mat-icon-button matTooltip="Cerrar" aria-label="Cerrar">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <mat-progress-bar *ngIf="vm.loading()" mode="indeterminate"></mat-progress-bar>

  <!-- Messages -->
  <div class="messages" #messagesBox>
    <div class="row" *ngFor="let m of vm.messages()">
      <div class="bubble" [class.mine]="m.role === 'user'">
        <div class="text">{{ m.text }}</div>
        <div class="meta">{{ m.createdAt | date: 'dd/MM HH:mm' }}</div>
      </div>
    </div>
  </div>

  <!-- Composer -->
  <div class="composer">
    <input
      #chatInput
      class="input"
      [value]="draft()"
      (input)="draft.set(($any($event.target).value))"
      placeholder="Escribe un mensaje…"
      aria-label="Escribe un mensaje"
    />

    <button mat-raised-button color="primary" (click)="send()" [disabled]="vm.sending()">
      {{ vm.sending() ? 'Enviando…' : 'Enviar' }}
    </button>
  </div>
</mat-card>

<!-- Menu -->
<mat-menu #chatMenu="matMenu">
  <button mat-menu-item (click)="clearChatView()">
    <mat-icon>delete_sweep</mat-icon>
    <span>Limpiar pantalla</span>
  </button>

  <button mat-menu-item (click)="reloadChat()">
    <mat-icon>refresh</mat-icon>
    <span>Recargar historial</span>
  </button>
</mat-menu>
