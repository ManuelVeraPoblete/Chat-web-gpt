<mat-card class="panel">
  <!-- Header -->
  <div class="header">
    <div class="title">
      <div class="h1">Asistente IA</div>

      <div class="subtitle-row">
        <div class="h2">Asistente Corporativo</div>

        <!-- ✅ Chip visible cuando se limpió la pantalla -->
        <mat-chip *ngIf="vm.viewCleared()" class="chip-clean" aria-label="Vista limpia">
          <mat-icon class="chip-ic" aria-hidden="true">delete_sweep</mat-icon>
          Vista limpia
        </mat-chip>
      </div>
    </div>

    <div class="actions">
      <!-- Menú 3 puntos -->
      <button
        mat-icon-button
        [matMenuTriggerFor]="aiMenu"
        matTooltip="Opciones"
        aria-label="Opciones"
      >
        <mat-icon>more_vert</mat-icon>
      </button>
    </div>
  </div>

  <mat-progress-bar *ngIf="vm.loading()" mode="indeterminate"></mat-progress-bar>

  <!-- Messages -->
  <div class="messages" #messagesBox>
    <div class="row" *ngFor="let m of vm.messages()">
      <div class="bubble" [class.mine]="isUserMessage(m)">
        <div class="text">{{ getText(m) }}</div>

        <!-- ✅ Evita error si createdAt viene null -->
        <div class="meta" *ngIf="getCreatedAt(m) as dt">
          {{ dt | date: 'dd/MM HH:mm' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Composer -->
  <div class="composer">
    <input
      #assistantInput
      class="input"
      [value]="draft()"
      (input)="draft.set(($any($event.target).value))"
      placeholder="Escribe tu pregunta…"
      aria-label="Escribe tu pregunta"
      (keydown.enter)="send()"
    />

    <button mat-raised-button color="primary" (click)="send()" [disabled]="vm.sending()">
      {{ vm.sending() ? 'Enviando…' : 'Enviar' }}
    </button>
  </div>
</mat-card>

<!-- ✅ Menú -->
<mat-menu #aiMenu="matMenu">
  <button mat-menu-item (click)="clearAiView()">
    <mat-icon>delete_sweep</mat-icon>
    <span>Limpiar pantalla</span>
  </button>

  <button mat-menu-item (click)="reloadAiHistory()">
    <mat-icon>refresh</mat-icon>
    <span>Recargar historial</span>
  </button>
</mat-menu>
